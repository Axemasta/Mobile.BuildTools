<?xml version="1.0" encoding="utf-8" ?>
<Project>

  <UsingTask TaskName="Mobile.BuildTools.Tasks.ScssProcessorTask"
             AssemblyFile="$(_MobileBuildToolsParentBuildTasksDll)"/>

  <PropertyGroup>
    <CssGDependsOn>
      _CollectScss;
      ProcessScss;
      $(CssGDependsOn);
    </CssGDependsOn>
    <PrepareResourcesDependsOn>
      _CollectScss;
      ProcessScss;
      $(PrepareResourcesDependsOn)
    </PrepareResourcesDependsOn>
    <ProcessScssDependsOn>
      _CollectScss;
    </ProcessScssDependsOn>
  </PropertyGroup>

  <Target Name="_CollectScss">
    <ItemGroup>
      <_AllScss Include="**\*.scss" />
      <_PartialScss Include="@(_AllScss)" Condition="$([MSBuild]::ValueOrDefault('%(Filename)', '').StartsWith('_'))" />
      <_Scss Include="@(_AllScss)" Exclude="@(_PartialScss)" />
    </ItemGroup>
  </Target>

  <Target Name="ProcessScss"
          BeforeTargets="CssG"
          AfterTargets="_CollectScss"
          DependsOnTargets="MobileBuildToolsInit"
          Inputs="@(_Scss);@(_PartialScc)"
          Outputs="@(_Scss -> '$(IntermediateOutputPath)%(RecursiveDir)%(Filename).css')"
          Condition=" '@(ReferencePath->WithMetadataValue('NuGetPackageId', 'Xamarin.Forms'))' != '' ">

    <PropertyGroup>
      <ProcessScssDebug Condition=" '$(ProcessScssDebug)' == '' ">$(MobileBuildToolsDebug)</ProcessScssDebug>
    </PropertyGroup>

    <ScssProcessorTask OutputDirectory="$(IntermediateOutputPath)"
                       ScssFiles="@(_Scss)"
                       DebugOutput="$(ProcessScssDebug)">
      <Output ItemName="GeneratedFile"
              TaskParameter="GeneratedCssFiles"/>
      <Output ItemName="FilesWrite"
              TaskParameter="GeneratedCssFiles"/>
    </ScssProcessorTask>

    <ItemGroup>
      <EmbeddedResource Include="@(_Scss -> '$(IntermediateOutputPath)%(RecursiveDir)%(Filename).css')"
                        Link="%(RecursiveDir)%(Filename).css"
                        Visible="true" />
    </ItemGroup>

  </Target>

</Project>
