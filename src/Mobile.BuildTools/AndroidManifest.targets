<?xml version="1.0" encoding="utf-8" ?>
<Project>

  <UsingTask TaskName="Mobile.BuildTools.Tasks.TemplateManifestTask"
             AssemblyFile="$(_MobileBuildToolsParentBuildTasksDll)"/>

  <PropertyGroup>
    <BeforeGenerateAndroidManifest>
      MobileBuildToolsInit;
      $(BeforeGenerateAndroidManifest);
    </BeforeGenerateAndroidManifest>
    <AfterGenerateAndroidManifest>
      HandleAndroidManifest;
      AutomaticBuildVersioning;
      $(AfterGenerateAndroidManifest);
    </AfterGenerateAndroidManifest>
</PropertyGroup>

  <Target Name="_MBTGatherManifests"
          BeforeTargets="HandleAndroidManifest"
          Condition="$(BuildToolsEnableTemplateManifests)">
    <PropertyGroup>
      <TemplateAppManifest>$(IntermediateOutputPath)android\AndroidManifest.xml</TemplateAppManifest>
      <ProcessedAppManifest>$([System.IO.Path]::Combine('$(IntermediateOutputPath)', 'templated', 'AndroidManifest.xml'))</ProcessedAppManifest>
      <VersionedAppManifest>$([System.IO.Path]::Combine('$(IntermediateOutputPath)', 'versioned', 'AndroidManifest.xml'))</VersionedAppManifest>
    </PropertyGroup>

    <ItemGroup>
      <TemplatedManifest Include="$(TemplateAppManifest)" Visible="false" />
      <TemplatedHandledManifest Include="$(ProcessedAppManifest)" Visible="false" />
      <VersionedPlist Include="$(VersionedAppManifest)" Visible="false" />
    </ItemGroup>
  </Target>

  <Target Name="HandleAndroidManifest"
          AfterTargets="_GenerateJavaStubs;_SetLatestTargetFrameworkVersion"
          DependsOnTargets="MobileBuildToolsInit">
    <TemplateManifestTask ConfigurationPath="$(BuildToolsConfigFilePath)"
                          ProjectName="$(MSBuildProjectName)"
                          ProjectDirectory="$(MSBuildProjectDirectory)"
                          SolutionDirectory="$(SolutionDir)"
                          Configuration="$(Configuration)"
                          IntermediateOutputPath="$(IntermediateOutputPath)"
                          TargetFrameworkIdentifier="$(TargetFrameworkIdentifier)"
                          ReferenceAssemblyPaths="$(_XATargetFrameworkDirectories)"
                          ManifestPath="$(TemplateAppManifest)"
                          Condition="$(BuildToolsEnableTemplateManifests)">
      <Output TaskParameter="ProcessedManifest"
              PropertyName="_AppManifest" />
    </TemplateManifestTask>
  </Target>

  <Target Name="AutomaticBuildVersioning"
          AfterTargets="HandleAndroidManifest;HandleTokenizedInfoPlist"
          DependsOnTargets="MobileBuildToolsInit">

    <AutomaticBuildVersioningTask ConfigurationPath="$(BuildToolsConfigFilePath)"
                                  ProjectName="$(MSBuildProjectName)"
                                  ProjectDirectory="$(MSBuildProjectDirectory)"
                                  SolutionDirectory="$(SolutionDir)"
                                  Configuration="$(Configuration)"
                                  IntermediateOutputPath="$(IntermediateOutputPath)"
                                  TargetFrameworkIdentifier="$(TargetFrameworkIdentifier)"
                                  ManifestPath="$(TemplateAppManifest)"
                                  ReferenceAssemblyPaths="$(_XATargetFrameworkDirectories)"
                                  Condition="$(BuildToolsEnableAutomaticVersioning)" >
      <!--<Output TaskParameter="VersionedManifest"
              PropertyName="_AppManifest" />-->
    </AutomaticBuildVersioningTask>
  </Target>

</Project>
